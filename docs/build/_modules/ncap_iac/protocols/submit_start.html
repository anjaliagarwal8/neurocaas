
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>ncap_iac.protocols.submit_start &#8212; NeuroCAAS 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ncap_iac.protocols.submit_start</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1">## Works when running in lambda:</span>
    <span class="kn">from</span> <span class="nn">utilsparam</span> <span class="k">import</span> <span class="n">s3</span> <span class="k">as</span> <span class="n">utilsparams3</span>
    <span class="kn">from</span> <span class="nn">utilsparam</span> <span class="k">import</span> <span class="n">ssm</span> <span class="k">as</span> <span class="n">utilsparamssm</span>
    <span class="kn">from</span> <span class="nn">utilsparam</span> <span class="k">import</span> <span class="n">ec2</span> <span class="k">as</span> <span class="n">utilsparamec2</span>
    <span class="kn">from</span> <span class="nn">utilsparam</span> <span class="k">import</span> <span class="n">events</span> <span class="k">as</span> <span class="n">utilsparamevents</span>
    <span class="kn">from</span> <span class="nn">utilsparam</span> <span class="k">import</span> <span class="n">pricing</span> <span class="k">as</span> <span class="n">utilsparampricing</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">## Most likely this comes from pytest and relative imports. </span>
        <span class="kn">from</span> <span class="nn">ncap_iac.protocols.utilsparam</span> <span class="k">import</span> <span class="n">s3</span> <span class="k">as</span> <span class="n">utilsparams3</span>
        <span class="kn">from</span> <span class="nn">ncap_iac.protocols.utilsparam</span> <span class="k">import</span> <span class="n">ssm</span> <span class="k">as</span> <span class="n">utilsparamssm</span>
        <span class="kn">from</span> <span class="nn">ncap_iac.protocols.utilsparam</span> <span class="k">import</span> <span class="n">ec2</span> <span class="k">as</span> <span class="n">utilsparamec2</span>
        <span class="kn">from</span> <span class="nn">ncap_iac.protocols.utilsparam</span> <span class="k">import</span> <span class="n">events</span> <span class="k">as</span> <span class="n">utilsparamevents</span>
        <span class="kn">from</span> <span class="nn">ncap_iac.protocols.utilsparam</span> <span class="k">import</span> <span class="n">pricing</span> <span class="k">as</span> <span class="n">utilsparampricing</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e_supp</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e_supp</span><span class="p">)</span>
        <span class="n">stacktrace</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Exception: &quot;</span> <span class="o">+</span> <span class="n">error</span> <span class="o">+</span> <span class="s2">&quot;  Stacktrace: &quot;</span> <span class="o">+</span> <span class="n">stacktrace</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="s2">&quot;400&quot;</span> <span class="k">if</span> <span class="n">err</span> <span class="k">else</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span>
        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">err</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
        <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">},</span>
    <span class="p">}</span>

<span class="c1">## Lambda code for developmemt. </span>
<div class="viewcode-block" id="Submission_dev"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev">[docs]</a><span class="k">class</span> <span class="nc">Submission_dev</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specific lambda for purposes of development.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="c1">## Initialize as before:</span>
        <span class="c1"># Get Upload Location Information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>
        <span class="c1">## Get directory above the input directory. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SUBMITDIR&quot;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="c1">## Now add in the time parameter: </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="c1">## We will index by the submit file name prefix if it exists: </span>
        <span class="n">submit_search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/submit.json)&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="n">submit_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">## If the filename is just &quot;submit.json, we just don&#39;t append anything to the job name. &quot;</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1">#### Parse submit file </span>
        <span class="n">submit_file</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        
        <span class="c1">## Machine formatted fields (error only available in lambda) </span>
        <span class="c1">## These next three fields check that the submit file is correctly formatted</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="c1">## KEY: Now set up logging in the input folder too: </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing timestamp when data was uploaded.&quot;</span><span class="p">)</span>

        <span class="c1">## Initialize s3 directory for this job. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span> <span class="o">=</span> <span class="s2">&quot;job_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_name</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">jobpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span> <span class="o">=</span> <span class="n">jobpath</span>
        <span class="c1">## And create a corresponding directory in the submit area. </span>
        <span class="n">create_jobdir</span>  <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>

        <span class="c1">## Create a logging object and write to it. </span>
        <span class="c1">## a logger for the submit area.  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">JobLogger_demo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Unique analysis version id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;versionid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Initializing EPI analysis: Parameter search for 2D LDS.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="c1">########################</span>
        <span class="c1">## Now parse the rest of the file. </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;instance_type&#39;</span><span class="p">]</span> <span class="c1"># TODO default option from config</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Using default instance type </span><span class="si">{}</span><span class="s2"> from config file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">]</span>
            <span class="c1"># Log this message </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

        <span class="c1">## Check that we have a dataname field:</span>
        <span class="n">submit_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: Submit file does not contain field </span><span class="si">{}</span><span class="s2">, needed to analyze data.&quot;</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">data_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="c1"># TODO validate extensions </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing data name to analyze&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;configname&quot;</span><span class="p">]</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">assign_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MISSING_CONFIG_ERROR&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;EPI analysis request detected with dataset </span><span class="si">{}</span><span class="s2">, config file </span><span class="si">{}</span><span class="s2">. Reading EPI blueprint.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="c1">########################## </span>
        <span class="c1">## Check for the existence of the corresponding data and config in s3. </span>
        <span class="c1">## Check that we have the actual data in the bucket.  </span>
        <span class="n">exists_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: S3 Bucket does not contain </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span><span class="s2">&quot;bucket and data naem&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataname given does not exist in bucket.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;configname given does not exist in bucket.&quot;</span><span class="p">)</span>
        <span class="c1">###########################</span>

        <span class="c1">## Now get the actual paths to relevant data from the foldername: </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">extract_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> 
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;we must have data to analyze.&quot;</span>

<div class="viewcode-block" id="Submission_dev.get_costmonitoring"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.get_costmonitoring">[docs]</a>    <span class="k">def</span> <span class="nf">get_costmonitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the cost incurred by a given group so far by looking at the logs bucket of the appropriate s3 folder.  </span>
<span class="sd">         </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## first get the path to the log folder we should be looking at. </span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="s2">&quot;group_name must exist.&quot;</span>
        <span class="n">logfolder_path</span> <span class="o">=</span> <span class="s2">&quot;logs/</span><span class="si">{}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_name</span><span class="p">)</span> 
        <span class="n">full_reportpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logfolder_path</span><span class="p">,</span><span class="s2">&quot;i-&quot;</span><span class="p">)</span>
        <span class="c1">## now get all of the computereport filenames: </span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">ls_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">full_reportpath</span><span class="p">)</span>

        <span class="c1">## for each, we extract the contents: </span>
        <span class="n">jobdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">## now calculate the cost:</span>
        <span class="k">for</span> <span class="n">jobfile</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
            <span class="n">instanceid</span> <span class="o">=</span> <span class="n">jobfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">full_reportpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">jobdata</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">jobfile</span><span class="p">)</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">jobdata</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">jobdata</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">jobdata</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">price</span><span class="o">*</span><span class="n">duration</span><span class="o">/</span><span class="mf">3600.</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1">## In rare cases it seems one or the other of these things don&#39;t actually have entries. This is a problem. for now, charge for the hour: </span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">price</span>
            <span class="n">cost</span><span class="o">+=</span> <span class="n">cost</span>
        
        <span class="c1">## Now compare with budget:</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MAXCOST&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Incurred cost so far: $</span><span class="si">{}</span><span class="s2">. Remaining budget: $</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="n">budget</span><span class="o">-</span><span class="n">cost</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">validjob</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">cost</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Incurred cost so far: $</span><span class="si">{}</span><span class="s2">. Over budget ($</span><span class="si">{}</span><span class="s2">), cancelling job. Contact administrator.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cost</span><span class="p">,</span><span class="n">budget</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">validjob</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">validjob</span></div>

<div class="viewcode-block" id="Submission_dev.parse_config"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.parse_config">[docs]</a>    <span class="k">def</span> <span class="nf">parse_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the config file given for specific neurocaas parameters. In particular, the *duration* of the job, and the *dataset size* </span>
<span class="sd">        TODO: check for type in these configuration files. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
            <span class="n">passed_config</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">:</span>
            <span class="n">passed_config</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobduration</span> <span class="o">=</span> <span class="n">passed_config</span><span class="p">[</span><span class="s2">&quot;__duration__&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;parameter __duration__ not given, proceeding with standard compute launch.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobduration</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span> <span class="o">=</span> <span class="n">passed_config</span><span class="p">[</span><span class="s2">&quot;__dataset_size__&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;parameter __dataset_size__ is not given, proceeding with standard compute launch.&quot;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Submission_dev.acquire_instances"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.acquire_instances">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Streamlines acquisition, setting up of multiple instances. Better exception handling when instances cannot be launched, and spot instances with defined duration when avaialble.   </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nb_instances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

        <span class="c1">## Check how many instances are running. </span>
        <span class="n">active</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">count_active_instances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="c1">## Ensure that we have enough bandwidth to support this request:</span>
        <span class="k">if</span> <span class="n">active</span> <span class="o">+</span><span class="n">nb_instances</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DEPLOY_LIMIT&#39;</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RESOURCE ERROR: Instance requests greater than pipeline bandwidth. Please contact NeuroCAAS admin&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Instance requests greater than pipeline bandwidth&quot;</span><span class="p">)</span>
        

        <span class="n">instances</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">launch_new_instances</span><span class="p">(</span>
        <span class="n">instance_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">,</span> 
        <span class="n">ami</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AMI&#39;</span><span class="p">],</span>
        <span class="n">logger</span><span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
        <span class="n">number</span> <span class="o">=</span> <span class="n">nb_instances</span><span class="p">,</span>
        <span class="n">add_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_volumesize</span><span class="p">,</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobduration</span>
        <span class="p">)</span>

        <span class="c1">## Even though we have a check in place, also check how many were launched:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;instances not launched. AWS capacity reached. Please contact NeuroCAAS admin.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">instances</span></div>

<div class="viewcode-block" id="Submission_dev.log_jobs"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.log_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">log_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Once instances are acquired, create logs that can be filled in as they run.  </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_logs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;instance-id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">instance_id</span> 
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s2">&quot;instance-id&quot;</span><span class="p">])</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;instance-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">instance_type</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">spot_instance_request_id</span><span class="p">:</span>
                <span class="n">log</span><span class="p">[</span><span class="s2">&quot;spot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="p">[</span><span class="s2">&quot;spot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utilsparampricing</span><span class="o">.</span><span class="n">price_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;databucket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;datapath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_name</span> 
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;jobpath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">utilsparams3</span><span class="o">.</span><span class="n">write_active_monitorlog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">log</span><span class="p">)</span>
            <span class="n">all_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_logs</span></div>




<div class="viewcode-block" id="Submission_dev.start_instance"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.start_instance">[docs]</a>    <span class="k">def</span> <span class="nf">start_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts new instances if stopped. We write a special loop for this one because we only need a single 60 second pause for all the intances, not one for each in serial. Specialized certificate messages. &quot;&quot;&quot;</span>
        <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">start_instances_if_stopped</span><span class="p">(</span>
            <span class="n">instances</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="p">[]</span><span class="c1">#self.logger</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="si">{}</span><span class="s2"> EPI infrastructures with 4 cpus, 16 GB memory &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Submission_dev.process_inputs"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.process_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initiates Processing On Previously Acquired EC2 Instance. This version requires that you include a config (fourth) argument &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="s1">&#39;bucket name&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span><span class="s1">&#39;filenames&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="s1">&#39;outdir&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">],</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;not enough arguments in the COMMAND argument.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not the correct format for arguments.&quot;</span><span class="p">)</span>
     

        <span class="c1">## Should we vectorize the log here? </span>
        <span class="n">outpath_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>

        <span class="c1">#[self.logger.append(&quot;Starting analysis with parameter set {}, dataset {}&quot;.format(</span>
        <span class="c1">#    f+1,</span>
        <span class="c1">#    filename</span>
        <span class="c1">#    )</span>
        <span class="c1">#) for f,filename in enumerate(self.filenames)]</span>
        <span class="c1">#[self.logger.append(&quot;Starting analysis with parameter set {}: {}&quot;.format(</span>
        <span class="c1">#    f+1,</span>
        <span class="c1">#    os.environ[&#39;COMMAND&#39;].format(</span>
        <span class="c1">#        self.bucket_name, filename, outpath_full, self.config_name</span>
        <span class="c1">#    )</span>
        <span class="c1">#)) for f,filename in enumerate(self.filenames)]</span>
        <span class="nb">print</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
              <span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">],</span><span class="s2">&quot;command send&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utilsparamssm</span><span class="o">.</span><span class="n">execute_commands_on_linux_instances</span><span class="p">(</span>
                <span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
                    <span class="p">)],</span> <span class="c1"># TODO: variable outdir as option</span>
                <span class="n">instance_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">],</span>
                <span class="n">working_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WORKING_DIRECTORY&#39;</span><span class="p">]],</span>
                <span class="n">log_bucket_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">log_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span><span class="p">,</span><span class="s1">&#39;internal_ec2_logs&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">initialize_datasets_dev</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;CommandId&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Starting analysis </span><span class="si">{}</span><span class="s2"> with parameter set </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;All jobs submitted. Processing...&quot;</span><span class="p">)</span></div>


    <span class="c1">## Declare rules to monitor the states of these instances.  </span>
<div class="viewcode-block" id="Submission_dev.put_instance_monitor_rule"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.put_instance_monitor_rule">[docs]</a>    <span class="k">def</span> <span class="nf">put_instance_monitor_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot; For multiple datasets.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Setting up monitoring on all instances.&quot;</span><span class="p">)</span> 
        <span class="n">ruledata</span><span class="p">,</span><span class="n">rulename</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instances_rule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="n">arn</span> <span class="o">=</span> <span class="n">ruledata</span><span class="p">[</span><span class="s1">&#39;RuleArn&#39;</span><span class="p">]</span>
        <span class="c1">## Now attach it to the given target</span>
        <span class="n">targetdata</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instance_target</span><span class="p">(</span><span class="n">rulename</span><span class="p">)</span> </div>

<div class="viewcode-block" id="Submission_dev.compute_volumesize"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.compute_volumesize">[docs]</a>    <span class="k">def</span> <span class="nf">compute_volumesize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the current ami volume size and adds in the size of the data that will be analyzed.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## First compute default volume size. </span>
        <span class="n">default_size</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">get_volumesize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;AMI&quot;</span><span class="p">])</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">full_volumesize</span> <span class="o">=</span> <span class="n">default_size</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">full_volumesize</span> <span class="o">=</span> <span class="n">default_size</span></div>

<span class="c1">## We are no longer using this function. It depends upon automation documents that can be found in the cfn utils_stack template. Consider using this as a reference when switching to automation documents instead of pure runcommand. </span>
<div class="viewcode-block" id="Submission_dev.add_volumes"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_dev.add_volumes">[docs]</a>    <span class="k">def</span> <span class="nf">add_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds volumes to the data you will process. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span><span class="p">,</span><span class="s2">&quot;self.jobsize&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="c1">## create a dictionary pairing your instance_ids with jobsize. </span>
            <span class="c1">## later we can tailor this. </span>
            <span class="n">instancedict</span> <span class="o">=</span> <span class="p">{</span><span class="n">inst</span><span class="o">.</span><span class="n">instance_id</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">jobsize</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">}</span>
            <span class="n">attach_responses</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">prepare_volumes</span><span class="p">(</span><span class="n">instancedict</span><span class="p">)</span>
            <span class="n">utilsparamssm</span><span class="o">.</span><span class="n">mount_volumes</span><span class="p">(</span><span class="n">attach_responses</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">pass</span></div></div>


<span class="c1">## Lambda code for deployment from other buckets. </span>
<div class="viewcode-block" id="Submission_deploy"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_deploy">[docs]</a><span class="k">class</span> <span class="nc">Submission_deploy</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object for ncap upload handling where inputs can come from specific user buckets. We then need to partition and replicate output between the user input bucket and the submit bucket. Input and submit buckets are structured as follows:  </span>
<span class="sd">    Input Bucket:</span>
<span class="sd">    -inputs</span>
<span class="sd">    +data</span>
<span class="sd">    +configs</span>
<span class="sd">    -results</span>
<span class="sd">    -job folder</span>
<span class="sd">    +results</span>
<span class="sd">    +per-dataset logs</span>
<span class="sd">    +per-job certificate</span>

<span class="sd">    Submit Bucket: </span>
<span class="sd">    - group name</span>
<span class="sd">    -inputs</span>
<span class="sd">    +submit.json files referencing the input bucket. </span>
<span class="sd">    -results</span>
<span class="sd">    +per-job certificate </span>
<span class="sd">    +internal ec2 logs. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="c1">#### Declare basic parameters: </span>
        <span class="c1"># Get Upload Location Information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>

        <span class="c1">## Important paths: </span>
        <span class="c1">## Get directory above the input directory where the job was submitted. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INDIR&quot;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="c1">## The other important directory is the actual base directory of the input bucket itself. </span>

        <span class="c1">## Now add in the time parameter: </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

        <span class="c1">#### Set up basic logging so we can get a trace when errors happen.   </span>
        <span class="c1">## We will index by the submit file name prefix if it exists: </span>
        <span class="n">submit_search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/submit.json)&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="n">submit_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">## If the filename is just &quot;submit.json, we just don&#39;t append anything to the job name. &quot;</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1">#### Parse submit file </span>
        <span class="n">submit_file</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        
        <span class="c1">## These next three fields check that the submit file is correctly formatted</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="c1">## KEY: Now set up logging in the input folder too: </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing timestamp when data was uploaded.&quot;</span><span class="p">)</span>

        <span class="c1">## Now we&#39;re going to get the path to the results directory in the submit folder: </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span> <span class="o">=</span> <span class="s2">&quot;job_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submit_name</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">jobpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobpath_submit</span> <span class="o">=</span> <span class="n">jobpath</span>
        <span class="c1">## And create a corresponding directory in the submit area. </span>
        <span class="n">create_jobdir</span>  <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="c1">## a logger for the submit area.  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">JobLogger_demo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Initializing EPI analysis: Parameter search for 2D LDS.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;instance_type&#39;</span><span class="p">]</span> <span class="c1"># TODO default option from config</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Using default instance type </span><span class="si">{}</span><span class="s2"> from config file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">]</span>

        <span class="c1">## Check that we have a dataname field:</span>
        <span class="n">submit_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: Submit file does not contain field </span><span class="si">{}</span><span class="s2">, needed to analyze data.&quot;</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;bucketname&quot;</span><span class="p">]</span>
            <span class="c1">## KEY: Now set up logging in the input folder too: </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">JobLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">))</span> <span class="c1">##TODO: this relies upon &quot;OUTDIR&quot; being the same in the submit and input buckets. Make sure to alter this later. </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing bucket name where data is located.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">data_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="c1"># TODO validate extensions </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing data name to analyze&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;configname&quot;</span><span class="p">]</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">assign_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MISSING_CONFIG_ERROR&quot;</span><span class="p">])</span>

        <span class="c1">## Check that we have the actual data in the bucket.  </span>
        <span class="n">exists_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: S3 Bucket does not contain </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataname given does not exist in bucket.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;configname given does not exist in bucket.&quot;</span><span class="p">)</span>

        <span class="c1">## Check what instance we should use. </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;instance_type&#39;</span><span class="p">]</span> 
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Instance type </span><span class="si">{}</span><span class="s2"> does not exist, using default from config file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">]</span>
            <span class="c1">## Log this message.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="c1">###########################</span>

        <span class="c1">## Now get the actual paths to relevant data from the foldername: </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">extract_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> 
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;we must have data to analyze.&quot;</span>

<div class="viewcode-block" id="Submission_deploy.acquire_instance"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_deploy.acquire_instance">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Acquires &amp; Starts New EC2 Instances Of The Requested Type &amp; AMI&quot;&quot;&quot;</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nb_instances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

        <span class="c1">## Check how many instances are running. </span>
        <span class="n">active</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">count_active_instances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="c1">## Ensure that we have enough bandwidth to support this request:</span>
        <span class="k">if</span> <span class="n">active</span> <span class="o">+</span><span class="n">nb_instances</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DEPLOY_LIMIT&#39;</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RESOURCE ERROR: Instance requests greater than pipeline bandwidth. Please contact NCAP administrator.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RESOURCE ERROR: Instance requests greater than pipeline bandwidth. Please contact NCAP administrator.&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_instances</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">launch_new_instance</span><span class="p">(</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">,</span> 
            <span class="n">ami</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AMI&#39;</span><span class="p">],</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span>
            <span class="p">)</span>
            <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">instances</span></div>

<div class="viewcode-block" id="Submission_deploy.start_instance"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_deploy.start_instance">[docs]</a>    <span class="k">def</span> <span class="nf">start_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts new instances if stopped. We write a special loop for this one because we only need a single 60 second pause for all the intances, not one for each in serial&quot;&quot;&quot;</span>
        <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">start_instances_if_stopped</span><span class="p">(</span>
            <span class="n">instances</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span>
        <span class="p">)</span></div>

    <span class="c1">## Declare rules to monitor the states of these instances.  </span>
<div class="viewcode-block" id="Submission_deploy.put_instance_monitor_rule"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_deploy.put_instance_monitor_rule">[docs]</a>    <span class="k">def</span> <span class="nf">put_instance_monitor_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot; For multiple datasets.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Setting up monitoring on instance &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Setting up monitoring on instance &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
            <span class="c1">## First declare a monitoring rule for this instance: </span>
            <span class="n">ruledata</span><span class="p">,</span><span class="n">rulename</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instance_rule</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span>
            <span class="n">arn</span> <span class="o">=</span> <span class="n">ruledata</span><span class="p">[</span><span class="s1">&#39;RuleArn&#39;</span><span class="p">]</span>
            <span class="c1">## Now attach it to the given target</span>
            <span class="n">targetdata</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instance_target</span><span class="p">(</span><span class="n">rulename</span><span class="p">)</span> </div>

<div class="viewcode-block" id="Submission_deploy.process_inputs"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_deploy.process_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initiates Processing On Previously Acquired EC2 Instance. This version requires that you include a config (fourth) argument &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span><span class="s1">&#39;bucket name&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span><span class="s1">&#39;filenames&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="s1">&#39;outdir&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">],</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;not enough arguments in the COMMAND argument.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not the correct format for arguments.&quot;</span><span class="p">)</span>

        <span class="c1">## Should we vectorize the log here? </span>
        <span class="n">outpath_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Sending command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
            <span class="p">)</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Sending command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
            <span class="p">)</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
              <span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">],</span><span class="s2">&quot;command sent&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utilsparamssm</span><span class="o">.</span><span class="n">execute_commands_on_linux_instances</span><span class="p">(</span>
                <span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
                    <span class="p">)],</span> <span class="c1"># TODO: variable outdir as option</span>
                <span class="n">instance_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">],</span>
                <span class="n">working_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WORKING_DIRECTORY&#39;</span><span class="p">]],</span>
                <span class="n">log_bucket_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">log_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobpath_submit</span><span class="p">,</span><span class="s1">&#39;internal_ec2_logs&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="c1">#self.submitlogger.initialize_datasets_dev(filename,self.instances[f].instance_id,response[&quot;Command&quot;][&quot;CommandId&quot;])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">initialize_datasets_dev</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;CommandId&quot;</span><span class="p">])</span></div></div>




<span class="c1">##########</span>
<span class="c1">#Legacy version kept in case things go horrifica</span>
<span class="c1">## Version to launch an instance</span>
<div class="viewcode-block" id="Submission_Launch"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch">[docs]</a><span class="k">class</span> <span class="nc">Submission_Launch</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Collection of data for a single request to process a dataset &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">acquire_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">start_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="c1">## Declare rules to monitor the states of these instances.  </span>
    <span class="k">def</span> <span class="nf">put_instance_monitor_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Submission_Launch_folder"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_folder">[docs]</a><span class="k">class</span> <span class="nc">Submission_Launch_folder</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generalization of Submission_Launch to a folder. Will launch a separate instance for each file in the bucket. Can be used to replace Submission_Launch whole-hog, as giving the path to the file will still work with this implementation.     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        
<div class="viewcode-block" id="Submission_Launch_folder.acquire_instance"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_folder.acquire_instance">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Acquires &amp; Starts New EC2 Instances Of The Requested Type &amp; AMI&quot;&quot;&quot;</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nb_instances</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span>

        <span class="c1">## Check how many instances are running. </span>
        <span class="n">active</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">count_active_instances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="c1">## Ensure that we have enough bandwidth to support this request:</span>
        <span class="k">if</span> <span class="n">active</span> <span class="o">+</span><span class="n">nb_instances</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DEPLOY_LIMIT&#39;</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RESOURCE ERROR: Instance requests greater than pipeline bandwidth. Please contact NCAP administrator.&quot;</span><span class="p">)</span>
        

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_instances</span><span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">launch_new_instance</span><span class="p">(</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span><span class="p">,</span> 
            <span class="n">ami</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AMI&#39;</span><span class="p">],</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
            <span class="p">)</span>
            <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">instances</span></div>

<div class="viewcode-block" id="Submission_Launch_folder.start_instance"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_folder.start_instance">[docs]</a>    <span class="k">def</span> <span class="nf">start_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts new instances if stopped. We write a special loop for this one because we only need a single 60 second pause for all the intances, not one for each in serial&quot;&quot;&quot;</span>
        <span class="n">utilsparamec2</span><span class="o">.</span><span class="n">start_instances_if_stopped</span><span class="p">(</span>
            <span class="n">instances</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="p">)</span></div>

    <span class="c1">## Declare rules to monitor the states of these instances.  </span>
<div class="viewcode-block" id="Submission_Launch_folder.put_instance_monitor_rule"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_folder.put_instance_monitor_rule">[docs]</a>    <span class="k">def</span> <span class="nf">put_instance_monitor_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot; For multiple datasets.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Setting up monitoring on instance &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
            <span class="c1">## First declare a monitoring rule for this instance: </span>
            <span class="n">ruledata</span><span class="p">,</span><span class="n">rulename</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instance_rule</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">instance_id</span><span class="p">)</span>
            <span class="n">arn</span> <span class="o">=</span> <span class="n">ruledata</span><span class="p">[</span><span class="s1">&#39;RuleArn&#39;</span><span class="p">]</span>
            <span class="c1">## Now attach it to the given target</span>
            <span class="n">targetdata</span> <span class="o">=</span> <span class="n">utilsparamevents</span><span class="o">.</span><span class="n">put_instance_target</span><span class="p">(</span><span class="n">rulename</span><span class="p">)</span> </div>

    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
      

<div class="viewcode-block" id="Submission_Launch_log_dev"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_log_dev">[docs]</a><span class="k">class</span> <span class="nc">Submission_Launch_log_dev</span><span class="p">(</span><span class="n">Submission_Launch_folder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Latest modification (11/1) to submit framework: spawn individual log files for each dataset. . </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
        <span class="c1">## Initialize as before:</span>
        <span class="c1"># Get Upload Location Information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span> <span class="o">=</span> <span class="n">bucket_name</span>
        <span class="c1">## Get directory above the input directory. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INDIR&quot;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="c1">## Now add in the time parameter: </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="c1">## We will index by the submit file name prefix if it exists: </span>
        <span class="n">submit_search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.+?(?=/submit.json)&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="n">submit_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">## If the filename is just &quot;submit.json, we just don&#39;t append anything to the job name. &quot;</span>
            <span class="n">submit_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            
        <span class="c1">## Now we&#39;re going to get the path to the results directory: </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span> <span class="o">=</span> <span class="s2">&quot;job&quot;</span><span class="o">+</span><span class="n">submit_name</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="n">jobpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span> <span class="o">=</span> <span class="n">jobpath</span>
        <span class="n">create_jobdir</span>  <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">JobLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span><span class="p">)</span>
        <span class="c1">#self.out_path = utilsparams3.mkdir(self.bucket_name, self.path, config.OUTDIR)</span>
        <span class="c1">#self.in_path = utilsparams3.mkdir(self.bucket_name, self.path, config.INDIR)</span>

        <span class="c1"># Load Content Of Submit File </span>
        <span class="n">submit_file</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="c1">## Check what instance we should use. </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;instance_type&#39;</span><span class="p">]</span> <span class="c1"># TODO default option from config</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Instance type </span><span class="si">{}</span><span class="s2"> does not exist, using default from config file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;INSTANCE_TYPE&quot;</span><span class="p">]</span>
            <span class="c1">## Log this message.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

        <span class="c1">## These next two check that the submit file is correctly formatted</span>
        <span class="c1">## Check that we have a dataname field:</span>
        <span class="n">submit_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: Submit file does not contain field </span><span class="si">{}</span><span class="s2">, needed to analyze data.&quot;</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">data_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s1">&#39;dataname&#39;</span><span class="p">]</span> <span class="c1"># TODO validate extensions </span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing data name to analyze&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span> <span class="o">=</span> <span class="n">submit_file</span><span class="p">[</span><span class="s2">&quot;configname&quot;</span><span class="p">]</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">assign_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ke</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="c1">## Write to logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="c1">## Now raise an exception to halt processing, because this is a catastrophic error.  </span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MISSING_CONFIG_ERROR&quot;</span><span class="p">])</span>

        <span class="c1">## Check that we have the actual data in the bucket.  </span>
        <span class="n">exists_errmsg</span> <span class="o">=</span> <span class="s2">&quot;INPUT ERROR: S3 Bucket does not contain </span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dataname given does not exist in bucket.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">):</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="n">exists_errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;configname given does not exist in bucket.&quot;</span><span class="p">)</span>
        <span class="c1">###########################</span>

        <span class="c1">## Now get the actual paths to relevant data from the foldername: </span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">utilsparams3</span><span class="o">.</span><span class="n">extract_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> 
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;we must have data to analyze.&quot;</span>

<div class="viewcode-block" id="Submission_Launch_log_dev.process_inputs"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.Submission_Launch_log_dev.process_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">process_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initiates Processing On Previously Acquired EC2 Instance. This version requires that you include a config (fourth) argument &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span><span class="s1">&#39;bucket name&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">,</span><span class="s1">&#39;filenames&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="s1">&#39;outdir&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">],</span><span class="s1">&#39;command&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;not enough arguments in the COMMAND argument.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not the correct format for arguments.&quot;</span><span class="p">)</span>
     

        <span class="c1">## Should we vectorize the log here? </span>
        <span class="n">outpath_full</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OUTDIR&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">)</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Sending command: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
            <span class="p">)</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
              <span class="p">)</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">],</span><span class="s2">&quot;command send&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utilsparamssm</span><span class="o">.</span><span class="n">execute_commands_on_linux_instances</span><span class="p">(</span>
                <span class="n">commands</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;COMMAND&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">outpath_full</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_name</span>
                    <span class="p">)],</span> <span class="c1"># TODO: variable outdir as option</span>
                <span class="n">instance_ids</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">],</span>
                <span class="n">working_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;WORKING_DIRECTORY&#39;</span><span class="p">]],</span>
                <span class="n">log_bucket_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                <span class="n">log_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobpath</span><span class="p">,</span><span class="s1">&#39;internal_ec2_logs&#39;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">initialize_datasets_dev</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">instance_id</span><span class="p">,</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">][</span><span class="s2">&quot;CommandId&quot;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="process_upload_log_dev"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.process_upload_log_dev">[docs]</a><span class="k">def</span> <span class="nf">process_upload_log_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Updated version that can handle config files. </span>
<span class="sd">    Inputs:</span>
<span class="sd">    key: absolute path to created object within bucket.</span>
<span class="sd">    bucket: name of the bucket within which the upload occurred.</span>
<span class="sd">    time: the time at which the upload event happened. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Conditionals for different deploy configurations: </span>
    <span class="c1">## First check if we are launching a new instance or starting an existing one. </span>
    <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LAUNCH&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="c1">## Now check how many datasets we have</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission_Launch_log_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LAUNCH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This option not available for configs. &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquiring&quot;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">acquire_instance</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing0&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting up monitor&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">put_instance_monitor_rule</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping monitor&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing1&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">start_instance</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing2&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sending&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">process_inputs</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing3&quot;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>

<div class="viewcode-block" id="process_upload_dev"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.process_upload_dev">[docs]</a><span class="k">def</span> <span class="nf">process_upload_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Updated version that can handle config files. </span>
<span class="sd">    Inputs:</span>
<span class="sd">    key: absolute path to created object within bucket.</span>
<span class="sd">    bucket: name of the bucket within which the upload occurred.</span>
<span class="sd">    time: the time at which the upload event happened. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Conditionals for different deploy configurations: </span>
    <span class="c1">## First check if we are launching a new instance or starting an existing one. </span>
    <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LAUNCH&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="c1">## Now check how many datasets we have</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LAUNCH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This option not available for configs. &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquiring&quot;</span><span class="p">)</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">submission</span><span class="o">.</span><span class="n">get_costmonitoring</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">parse_config</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computing volumesize&quot;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">compute_volumesize</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing1&quot;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">acquire_instances</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing2&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

        <span class="n">submission</span><span class="o">.</span><span class="n">log_jobs</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;logging&quot;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting up monitor&#39;</span><span class="p">)</span>
            <span class="n">submission</span><span class="o">.</span><span class="n">put_instance_monitor_rule</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping monitor&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing3&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">start_instance</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing4&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sending&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">process_inputs</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing5&quot;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span></div>

<span class="c1">## New 2/11: for disjoint data and upload buckets. </span>
<div class="viewcode-block" id="process_upload_deploy"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.process_upload_deploy">[docs]</a><span class="k">def</span> <span class="nf">process_upload_deploy</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Updated version that can handle config files. </span>
<span class="sd">    Inputs:</span>
<span class="sd">    key: absolute path to created object within bucket.</span>
<span class="sd">    bucket: name of the bucket within which the upload occurred.</span>
<span class="sd">    time: the time at which the upload event happened. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## Conditionals for different deploy configurations: </span>
    <span class="c1">## First check if we are launching a new instance or starting an existing one. </span>
    <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LAUNCH&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="c1">## Now check how many datasets we have</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">Submission_deploy</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LAUNCH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This option not available for configs. &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;acquiring&quot;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">acquire_instance</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing0&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="c1">## NOTE: IN LAMBDA,  JSON BOOLEANS ARE CONVERTED TO STRING</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting up monitor&#39;</span><span class="p">)</span>
        <span class="n">submission</span><span class="o">.</span><span class="n">put_instance_monitor_rule</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MONITOR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skipping monitor&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing1&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">start_instance</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing2&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sending&#39;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">process_inputs</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing3&quot;</span><span class="p">)</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">inputlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
    <span class="n">submission</span><span class="o">.</span><span class="n">submitlogger</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="handler_log_dev"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.handler_log_dev">[docs]</a><span class="k">def</span> <span class="nf">handler_log_dev</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newest version of handler that logs outputs to a subfolder of the result folder that is indexed by the job submission date and the submit name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;eventTime&#39;</span><span class="p">]</span>
        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;handler_params&quot;</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">,</span><span class="s1">&#39;event, context&#39;</span><span class="p">)</span>
        <span class="n">process_upload_log_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span></div>

<div class="viewcode-block" id="handler_develop"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.handler_develop">[docs]</a><span class="k">def</span> <span class="nf">handler_develop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newest version of handler that logs outputs to a subfolder of the result folder that is indexed by the job submission date and the submit name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;eventTime&#39;</span><span class="p">]</span>
        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;handler_params&quot;</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">,</span><span class="s1">&#39;event, context&#39;</span><span class="p">)</span>
        <span class="n">process_upload_dev</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span></div>

<div class="viewcode-block" id="handler_deploy"><a class="viewcode-back" href="../../../reference/protocols.html#ncap_iac.protocols.submit_start.handler_deploy">[docs]</a><span class="k">def</span> <span class="nf">handler_deploy</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    E</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;eventTime&#39;</span><span class="p">]</span>
        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;bucket&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;handler_params&quot;</span><span class="p">,</span><span class="n">bucket_name</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">context</span><span class="p">,</span><span class="s1">&#39;event, context&#39;</span><span class="p">)</span>
        <span class="n">process_upload_deploy</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">NeuroCAAS</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/installation.html">Installing NeuroCAAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develop/quickstart.html">Getting Started with NeuroCAAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/protocols.html">Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/userprofiles.html">User Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/devtools.html">Developer Tools</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Taiga Abe.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>